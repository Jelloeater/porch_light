version: '3'
tasks:
    # Docker
    purge: sudo docker system prune -a -f --volumes
    run:
        dotenv: [ '.env', '{{.ENV}}/.env.', '{{.HOME}}/.env' ] # Setup env vars from file for docker run
        cmds:
            -   task: build
            - sudo docker run -d --rm --name porch_light -e HUBITAT_API_APP_ID=$HUBITAT_API_APP_ID -e HUBITAT_API_TOKEN=$HUBITAT_API_TOKEN porch_light:latest
    # Docker Remote
    login: ssh-copy-id root@docker >> /dev/null
    build: sudo docker build . -t porch_light:latest
    attach: sudo docker attach porch_light
    kill: ssh root@docker 'docker kill porch_light'
    logs: ssh root@docker 'docker logs porch_light'
    deploy:
        - rsync -av --delete --filter=':- .gitignore' . root@docker:/porch_light/
        - task: show_secrets
        - rsync .env root@docker:/porch_light/.env
        - ssh root@docker 'docker rm -f porch_light; cd /porch_light/; task run'
        - rsync -av --delete --filter=':- .gitignore' . root@docker:/porch_light/
        - task: save_secrets
