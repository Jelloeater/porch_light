version: '3'
vars:
    FOLDER: pl_worker
    IMAGE_NAME: pl_worker
    DOCKER_FILE: Dockerfile
tasks:
    default:
        desc: Deploy to remote docker host
        cmds:
            - rsync -av --delete --filter=':- .gitignore' . root@docker:/{{.FOLDER}}/
            - git secret reveal -f
            - rsync .env root@docker:/{{.FOLDER}}/.env
            - ssh root@docker 'cd /{{.FOLDER}}/; task setup; task deploy:docker;' # Setup Env on remote box
            - rsync -av --delete --filter=':- .gitignore' . root@docker:/{{.FOLDER}}/
    docker: # These are the commands that get run remotely from above
        - docker rm -f {{.IMAGE_NAME}}
        - docker build . -t {{.IMAGE_NAME}}:latest -f {{.DOCKER_FILE}}
        - docker run --env-file .env -d --name {{.IMAGE_NAME}} {{.IMAGE_NAME}}:latest
